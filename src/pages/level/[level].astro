---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { stripMd, orderFromPart } from "../../lib/lesson-nav";

export async function getStaticPaths() {
  const entries: CollectionEntry<"lessons">[] = await getCollection("lessons");
  const folders = Array.from(new Set(entries.map((e) => e.id.split("/")[0])));
  return folders.map((folder) => ({ params: { level: folder } }));
}

const entries: CollectionEntry<"lessons">[] = await getCollection("lessons");
const levelFolder = Astro.params.level!;
const levelEntries = entries.filter((e) => e.id.startsWith(levelFolder + "/"));

if (levelEntries.length === 0) {
  return new Response("No lessons in this level yet.", { status: 404 });
}

const sorted = [...levelEntries].sort((a, b) => {
  const ap = stripMd(a.id).split("/");
  const bp = stripMd(b.id).split("/");

  const max = Math.max(ap.length, bp.length);
  for (let i = 0; i < max; i++) {
    const ao = orderFromPart(ap[i] ?? "");
    const bo = orderFromPart(bp[i] ?? "");
    if (ao !== bo) return ao - bo;

    const cmp = (ap[i] ?? "").localeCompare(bp[i] ?? "");
    if (cmp !== 0) return cmp;
  }
  return 0;
});

const firstHref = "/lessons/" + stripMd(sorted[0].id);

return Astro.redirect(firstHref, 302);
---
