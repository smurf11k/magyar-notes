---
export interface Props {
  text: string;
  label?: string;
}

const { text, label = "Listen" } = Astro.props;
---

<button
  class="ttsButton"
  data-text={text}
  title="Якщо вимова звучить неправильно або не працює, спробуйте встановити угорський голосовий пакет на вашому пристрої."
>
  <svg
    class="icon"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    xmlns="http://www.w3.org/2000/svg"
  >
    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
    <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
  </svg>
  <span>{label}</span>
</button>

<style>
  .ttsButton {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--muted);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
    font-family: inherit;
  }

  .ttsButton:hover {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
    transform: translateY(-1px);
  }

  .ttsButton:active {
    transform: translateY(0);
  }

  .ttsButton.speaking {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }

  .icon {
    width: 16px;
    height: 16px;
    stroke-width: 2;
  }

  .ttsButton.speaking .icon {
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }
</style>

<script>
  const buttons = document.querySelectorAll(".ttsButton");
  let currentAudio: HTMLAudioElement | null = null;

  function stopAll() {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.currentTime = 0;
      currentAudio = null;
    }
    document
      .querySelectorAll(".ttsButton.speaking")
      .forEach((b) => b.classList.remove("speaking"));
  }

  async function playWiktionaryAudio(word: string) {
    const res = await fetch(
      `/.netlify/functions/pronounce?word=${encodeURIComponent(word)}`,
    );

    // For testing: do NOT fallback.
    if (!res.ok) {
      const body = await res.text().catch(() => "");
      throw new Error(`Netlify function failed: ${res.status} ${body}`);
    }

    const data = await res.json();

    if (!data || typeof data.url !== "string") {
      throw new Error("Function returned JSON without { url }");
    }

    currentAudio = new Audio(data.url);
    currentAudio.crossOrigin = "anonymous";

    await currentAudio.play();
  }

  buttons.forEach((button) => {
    button.addEventListener("click", async () => {
      const text = button.getAttribute("data-text") || "";

      if (!text) return;

      if (button.classList.contains("speaking")) {
        stopAll();
        return;
      }

      stopAll();
      button.classList.add("speaking");

      try {
        await playWiktionaryAudio(text);

        if (currentAudio) {
          currentAudio.onended = () => button.classList.remove("speaking");
          currentAudio.onerror = () => button.classList.remove("speaking");
        }
      } catch (e) {
        button.classList.remove("speaking");
        console.error(e);
      }
    });
  });

  window.addEventListener("beforeunload", () => stopAll());
</script>
